# Notebook Data Volumes ì¶”ê°€

- **Type** : `Empty volume` 
- **Name** : `model-volume`
- **Storage class** : `nfs-client`
- **Access mode** : `ReadWriteOnce`
- **Mount path** : `/home/jovyan/model-volume` 

# Train the Model (PVC)

```py
import os
from sklearn import svm
from sklearn import datasets
from joblib import dump

iris = datasets.load_iris()
X, y = iris.data, iris.target

clf = svm.SVC(gamma='scale')
clf.fit(X, y)

model_dir = '/home/jovyan/model-volume/test-model'
os.makedirs(model_dir, exist_ok=True)  

dump(clf, '/home/jovyan/model-volume/test-model/model.joblib')
```

# Model ë°°í¬ (PVC)

> Namespaceì— ResourceQuotaê°€ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš° Limit Range ì„¤ì • ì—†ì´ ê·¸ëƒ¥ ë°°í¬í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë°œìƒ    
> `RevisionFailed: Revision "sklearn-pvc-predictor-00001" failed with message: pods "sklearn-pvc-predictor-00001-deployment-xxx" is forbidden: failed quota: kf-resource-quota: must specify memory for: queue-proxy.`

- Limit Range ì„¤ì •

```bash
cat << EOF | kubectl apply -f -
apiVersion: v1
kind: LimitRange
metadata:
  name: default-resources
  namespace: kubeflow-test-test-com
spec:
  limits:
  - type: Container
    defaultRequest:
      memory: "128Mi"
      cpu: "50m"
    default:
      memory: "256Mi"
      cpu: "200m"
EOF
```

- KServe Endpoints > New Endpoint ì—ì„œ ë°°í¬í•˜ê±°ë‚˜ ì•„ë˜ ëª…ë ¹ì–´ ê·¸ëŒ€ë¡œ ì‹¤í–‰

```bash
cat << EOF | kubectl apply -f -
apiVersion: "serving.kserve.io/v1beta1"
kind: "InferenceService"
metadata:
  name: "sklearn-pvc"
spec:
  predictor:
    model:
      modelFormat:
        name: sklearn
      storageUri: "pvc://model-volume/test-model/"    
EOF
```


# Model Test (with. Notebook)

- Jupyter Notebook ì—ì„œ í…ŒìŠ¤íŠ¸ ì§„í–‰
- ğŸ˜¥ `RBAC: access denied` ì—ëŸ¬ ë°œìƒ
- K8S Cluster ë‚´ë¶€ì—ì„œ ëª¨ë¸ í˜¸ì¶œ í—ˆìš©í•˜ê¸° ìœ„í•œ `AuthorizationPolicy` ì„¤ì • í•„ìš”í•¨

```py
import requests
import json

# ëª¨ë¸ì— ì…ë ¥í•  ë°ì´í„°
sklearn_iris_input = dict(instances=[
    [6.8, 2.8, 4.8, 1.4],
    [6.0, 3.4, 4.5, 1.6]
])

# ìš”ì²­í•  URL
url = "http://sklearn-pvc.kubeflow-test-test-com.svc.cluster.local/v1/models/sklearn-pvc:predict"

# POST ìš”ì²­ ë³´ë‚´ê¸°
response_internal = requests.post(url, data=json.dumps(sklearn_iris_input))

# ì‘ë‹µ ì¶œë ¥
print(response_internal.text)
```

# Model Test (with. Curl)

```bash
# Notebook Pod ë‚´ì—ì„œ í˜¸ì¶œ
curl -H 'Content-Type: application/json' -X POST http://sklearn-pvc.kubeflow-test-test-com.svc.cluster.local/v1/models/sklearn-pvc:predict -d '{
    "instances": [
        [6.8, 2.8, 4.8, 1.4],
        [6.0, 3.4, 4.5, 1.6]
    ]
}'

# Test Pod ì‹¤í–‰ í›„ í˜¸ì¶œ 
kubectl run curl-test --restart=Never --rm -i --tty --image curlimages/curl -- /bin/sh -c "curl -H 'Content-Type: application/json' \
  -X POST http://sklearn-pvc.kubeflow-test-test-com.svc.cluster.local/v1/models/sklearn-pvc:predict -d '{\"instances\":[
    [6.8, 2.8, 4.8, 1.4],
    [6.0, 3.4, 4.5, 1.6]
  ]
}'"
```


# K8S Cluster ë‚´ë¶€ì—ì„œ ëª¨ë¸ í˜¸ì¶œ í—ˆìš© ì„¤ì •

```bash
# AuthorizationPolicy ì„¤ì • (allowlist-by-paths)
cat <<EOF | tee ~/allowlist-by-paths.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allowlist-by-paths
  namespace: istio-system
spec:
  action: ALLOW
  rules:
  - to:
    - operation:
        paths:
        - /metrics
        - /healthz
        - /ready
        - /wait-for-drain
        - /v1/models/*
        - /v2/models/*
EOF
kubectl apply -f ~/allowlist-by-paths.yaml
```
